<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLAZE AND STEEL</title>
    <style>
        /* Vari√°veis de Cores (CSS Custom Properties) */
        :root {
            --color-primary: #1e1e2d;
            --color-secondary: #36364f;
            --color-text: #e0e0e0;
            --color-accent: #f39c12; /* Ouro */
            --color-combat: #c0392b; /* Combate/Aventura */
            --color-evolve: #8e44ad; /* Evoluir/Treinamento */
            --color-soul: #9b59b6; /* Alma/Reencarna√ß√£o */
            --color-hp: #2ecc71; /* HP/Vida */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-primary);
            color: var(--color-text);
            margin: 0;
            display: flex; /* ESSENCIAL PARA O MENU LATERAL */
            min-height: 100vh; /* ESSENCIAL PARA O MENU LATERAL */
            overflow: hidden; 
        }

        /* Estrutura Geral */
        #game-container {
            display: flex;
            width: 100%;
        }

        /* Menu Lateral (Sidebar) */
        #sidebar {
            width: 250px;
            background-color: var(--color-secondary);
            padding: 20px 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* NOVO: Estilo da Logo */
        #game-logo {
            width: 80%;
            max-width: 200px;
            height: auto;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 2px solid var(--color-accent); 
        }

        #hero-info, #stats-summary {
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.2);
        }

        #stats-summary p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* Bot√µes de Navega√ß√£o */
        #navigation-menu button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--color-accent);
            color: var(--color-primary);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #navigation-menu button:hover {
            background-color: #e67e22;
        }

        /* √Årea de Conte√∫do (Main Content) */
        #content-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 100vh;
        }

        /* Pain√©is de Conte√∫do */
        .content-panel {
            background-color: var(--color-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .content-panel h3 {
            border-bottom: 1px solid var(--color-accent);
            padding-bottom: 5px;
            margin-top: 0;
            color: var(--color-accent);
        }

        /* Estilos de Combate */
        #adventure-map-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .zone-card {
            background-color: var(--color-primary);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--color-secondary);
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .zone-card:hover {
            border-color: var(--color-accent);
            background-color: #2a2a3e;
        }

        .zone-card.selected {
            border-color: var(--color-combat);
            box-shadow: 0 0 10px var(--color-combat);
        }

        .zone-card h4 {
            margin-top: 0;
            color: var(--color-hp);
        }
        
        #perform-action-button {
            width: 100%;
            padding: 15px 25px;
            background-color: var(--color-combat);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.2s;
        }

        #perform-action-button:hover {
            background-color: #a5281b;
        }
        
        /* Estilo para barra de progresso (HP e EXP) */
        .progress-bar {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            height: 18px;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 18px;
        }

        #exp-bar .progress-fill { background-color: var(--color-evolve); }
        #hp-bar .progress-fill { background-color: var(--color-hp); }

        /* Estilos para o Invent√°rio e Equipamento */
        #inventory-grid, #equipment-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .item-slot, .equipment-slot {
            width: 60px;
            height: 60px;
            background-color: var(--color-primary);
            border: 2px solid var(--color-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .item-slot.full {
            border-color: var(--color-accent);
        }

        .item-slot.rarity-Comum { border-color: #ffffff; }
        .item-slot.rarity-Raro { border-color: var(--color-evolve); }
        .item-slot.rarity-√âpico { border-color: var(--color-combat); }

        .equipment-slot {
            width: 70px;
            height: 70px;
            border: 2px dashed var(--color-text);
            flex-direction: column;
            font-size: 0.7em;
            text-align: center;
        }

        .item-slot img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }
        
        .item-slot .item-quantity {
            position: absolute;
            bottom: 0;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            padding: 0 3px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        /* Estilos para o Painel de Cria√ß√£o */
        #class-selection-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .class-card {
            background-color: var(--color-primary);
            border: 2px solid var(--color-secondary);
            border-radius: 8px;
            padding: 15px;
            width: 200px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .class-card:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent);
        }

        .class-card.selected {
            border-color: var(--color-evolve);
            box-shadow: 0 0 15px var(--color-evolve);
        }

        .class-card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        
    </style>
</head>
<body>

<audio id="theme-music" loop autoplay style="display: none;">
    <source src="theme.mp3" type="audio/mpeg"> 
    </audio>

<div id="game-container">
    
    <div id="sidebar">
        
        <img id="game-logo" src="image_631587.png" alt="Blaze and Steel Logo">

        <div id="hero-info">
            <h3 id="hero-name-display">Novo Her√≥i</h3>
            <p>N√≠vel: <span id="power-level-display">1</span></p>
            <p>EXP:</p>
            <div id="exp-bar" class="progress-bar"><div class="progress-fill" style="width: 0%;">0/50</div></div>
        </div>

        <div id="stats-summary">
            <h3>Estat√≠sticas R√°pidas</h3>
            <p>‚ù§Ô∏è HP: <span id="hp-current-display">10</span>/<span id="hp-max-display">10</span></p>
            <div id="hp-bar" class="progress-bar"><div class="progress-fill" style="width: 100%;">100%</div></div>
            <p>‚öîÔ∏è ATK Base: <span id="atk-base-display">1</span></p>
            <p>üí∞ Gold: <span id="gold-display">0</span></p>
            <p>üåå Soul: <span id="soul-display">0</span></p>
        </div>

        <div id="navigation-menu">
            <button onclick="showPanel('combat-panel')">Mapa da Aventura</button>
            <button onclick="showPanel('upgrades-panel')">Treinamento (Upgrades)</button>
            <button onclick="showPanel('inventory-panel')">Invent√°rio</button>
            <button onclick="showPanel('equipment-panel')">Equipamento</button>
            <button onclick="showPanel('shop-panel')">Loja</button>
            <button onclick="saveGame(true)">Salvar Jogo</button>
            <button onclick="forceCreationPanel()" style="background-color: var(--color-soul);">Nova Hist√≥ria/Criar</button> 
            <button onclick="deleteGame(true)" style="background-color: var(--color-combat);">Reiniciar Jogo</button>
        </div>
    </div>

    <div id="content-area">

        <div id="creation-panel" style="display: none;">
            <h1>Bem-vindo a Blaze and Steel!</h1>
            <div class="content-panel">
                <h3>Passo 1: Nomeie seu Her√≥i</h3>
                <input type="text" id="hero-name-input" placeholder="Digite o nome do seu her√≥i..." style="width: 100%; padding: 10px; font-size: 1.1em; margin-bottom: 20px; box-sizing: border-box;">
                
                <h3>Passo 2: Escolha sua Classe</h3>
                <div id="class-selection-grid">
                    <div class="class-card" data-class="warrior" onclick="selectClass('warrior')">
                        <img src="image_6309cc.jpg" alt="Guerreiro">
                        <strong>Guerreiro</strong>
                    </div>
                    <div class="class-card" data-class="mage" onclick="selectClass('mage')">
                        <img src="image_63192f.png" alt="Mago">
                        <strong>Mago</strong>
                    </div>
                     <div class="class-card" data-class="assassin" onclick="selectClass('assassin')">
                        <img src="image_0b9ca2.jpg" alt="Assassino">
                        <strong>Assassino</strong>
                    </div>
                </div>
            </div>
            
            <div id="class-details-panel" class="content-panel" style="display: none;">
                <h3>Detalhes da Classe: <span id="selected-class-name"></span></h3>
                <p id="class-description"></p>
                
                <h4>Estat√≠sticas Iniciais</h4>
                <p>‚ù§Ô∏è HP Base: <span id="class-base-hp"></span></p>
                <p>‚öîÔ∏è ATK Base: <span id="class-base-atk"></span></p>
                <p>‚öîÔ∏è Equipamento Inicial: <span id="class-initial-equipment"></span></p>
                
                <button onclick="finalizeCreation()" style="background-color: var(--color-evolve); padding: 10px 20px; font-size: 1.1em; margin-top: 15px; width: 100%;">COME√áAR JOGO</button>
            </div>
        </div>

        <div id="combat-panel" style="display: none;">
            <h1>üó∫Ô∏è Mapa da Aventura</h1>
            
            <div class="content-panel">
                <h3>Escolha a Zona de Ca√ßa</h3>
                <div id="adventure-map-container">
                    </div>
            </div>
            
            <div class="content-panel">
                <h3>Progresso na Zona: <span id="current-zone-name-display">Borda da Floresta</span></h3>
                <p>Monstro Alvo: <strong id="current-monster-name-display">Goblin Fraco</strong> (Nv <span id="current-monster-level-display">1</span>)</p>
                <p>Perda de HP Estimada por A√ß√£o: <span id="hp-loss-display">1</span></p>
                
                <button id="perform-action-button" onclick="performAction()">ATACAR / PROGREDIR</button>
                <p id="combat-log" style="margin-top: 15px; padding: 10px; background-color: rgba(0, 0, 0, 0.3); border-radius: 5px;">Selecione uma zona para come√ßar a aventura...</p>
            </div>
        </div>
        
        <div id="upgrades-panel" style="display: none;">
             <h2>üí™ Treinamento B√°sico</h2>
             <div class="content-panel">
                 <h3>Ataque F√≠sico</h3>
                 <p>Ataque Base Atual: <span id="atk-base-upgrade-display">1</span></p>
                 <p>Pr√≥ximo Upgrade (+1 ATK Base): <span id="atk-cost-display">50</span> Gold</p>
                 <button onclick="buyUpgrade('atk')">Comprar Upgrade</button>
             </div>
             
             <div class="content-panel">
                 <h3>Pontos de Vida</h3>
                 <p>HP Base Atual: <span id="hp-base-upgrade-display">10</span></p>
                 <p>Pr√≥ximo Upgrade (+10 HP Base): <span id="hp-cost-display">50</span> Gold</p>
                 <button onclick="buyUpgrade('hp')">Comprar Upgrade</button>
             </div>
        </div>

        <div id="inventory-panel" style="display: none;">
            <h1>üéí Invent√°rio</h1>
            <div class="content-panel">
                <h3>Itens (Capacidade: 50)</h3>
                <div id="inventory-grid">
                    </div>
            </div>

            <div id="item-inspection-panel" class="content-panel" style="display: none;">
                <h3>Detalhes do Item: <span id="inspected-item-name"></span></h3>
                <p>Raridade: <span id="inspected-item-rarity"></span></p>
                <p>Tipo: <span id="inspected-item-type"></span></p>
                <p>Descri√ß√£o: <span id="inspected-item-description"></span></p>
                <p id="inspected-item-stats"></p>
                <button id="equip-unequip-button" onclick="" style="background-color: var(--color-accent); padding: 8px 15px; margin-top: 10px;">Equipar</button>
            </div>
        </div>

        <div id="equipment-panel" style="display: none;">
            <h1>‚öôÔ∏è Equipamento</h1>
            <div class="content-panel">
                <div id="equipment-slots">
                    </div>
            </div>
        </div>
        
        <div id="shop-panel" style="display: none;">
            <h1>üõçÔ∏è Loja da Cidade</h1>
            <div class="content-panel">
                <h3>Itens em Destaque (Compre com Gold)</h3>
                <div id="shop-items-display">
                    </div>
            </div>
        </div>
        
    </div>
</div>

<script>
    // Flag de Jogo Iniciado
    let gameInitialized = false;
    let selectedClass = null;
    let inspectedItem = null;

    // ====================================================================
    // I. VARI√ÅVEIS GLOBAIS E ESTRUTURAS DE DADOS
    // ====================================================================

    // VARI√ÅVEIS DO JOGO (Status, N√≠vel, Recursos)
    let heroName = "Her√≥i Desconhecido";
    let powerLevel = 1;
    let currentExp = 0;
    let expToNextLevel = 50;
    let gold = 0;
    let soul = 0;
    
    // Vari√°veis de Combate
    let heroBaseHP = 10; // HP Base do Her√≥i
    let heroBaseATK = 1; // ATK Base do Her√≥i
    let heroCurrentHP = 10;
    let heroMaxHP = 10;
    let heroTotalATK = 1;

    // Vari√°veis de Upgrades
    let atkUpgradeCost = 50;
    let hpUpgradeCost = 50;

    // Estrutura do Invent√°rio
    let inventory = [];

    // Estrutura de Classes do Personagem (SEM ENERGIA)
    const CLASSES = {
        warrior: {
            name: "Guerreiro",
            description: "Especialista em combate corpo-a-corpo, focado em vida e dano balanceado.",
            initialHP: 15,
            initialATK: 2,
            imagePath: "image_6309cc.jpg",
            startingItems: [ 
                { id: 1, name: "Espada Curta", type: "weapon", atk: 2, rarity: "Comum", description: "Uma l√¢mina b√°sica de treinamento." }, 
                { id: 2, name: "Armadura de Couro", type: "armor", hpBonus: 10, rarity: "Comum", description: "Prote√ß√£o leve e confi√°vel." } 
            ]
        },
        mage: {
            name: "Mago",
            description: "Fr√°gil, mas com alto potencial de dano m√°gico.",
            initialHP: 10,
            initialATK: 1,
            imagePath: "image_63192f.png",
            startingItems: [ 
                { id: 3, name: "Cajado de Madeira", type: "weapon", atk: 1, rarity: "Comum", description: "Um cajado simples para canalizar magia." }, 
                { id: 4, name: "Manto de Pano", type: "armor", hpBonus: 5, rarity: "Comum", description: "Um manto b√°sico para prote√ß√£o e foco." } 
            ]
        },
        assassin: {
            name: "Assassino",
            description: "Focado em dano explosivo e evas√£o. Come√ßa com uma adaga.",
            initialHP: 12, 
            initialATK: 3,
            imagePath: "image_0b9ca2.jpg",
            startingItems: [ 
                { id: 5, name: "Adaga R√°pida", type: "weapon", atk: 3, rarity: "Comum", description: "Uma adaga leve para ataques r√°pidos." }, 
                { id: 6, name: "Capuz Sombrio", type: "armor", hpBonus: 7, rarity: "Comum", description: "Um capuz que oferece pouca, mas essencial, prote√ß√£o." } 
            ]
        }
    };
    
    // Slots de Equipamento
    const EQUIPMENT_SLOTS = {
        weapon: { name: "Arma", currentItem: null },
        armor: { name: "Armadura", currentItem: null },
    };

    // Itens da Loja
    const SHOP_ITEMS = [
        { id: 10, name: "Po√ß√£o de HP", type: "consumable", effect: { hp: 50 }, price: 20, rarity: "Comum", description: "Restaura uma pequena quantidade de vida." },
        { id: 11, name: "Amuleto B√°sico", type: "accessory", atk: 2, hpBonus: 5, price: 100, rarity: "Raro", description: "Um pequeno b√¥nus em ATK e HP." },
    ];
    
    // ====================================================================
    // II. ESTRUTURA DE DADOS PARA O MAPA E COMBATE (NOVO)
    // ====================================================================

    const ZONES = {
        forest_edge: {
            name: "Borda da Floresta",
            levelRange: "Nv 1 - 5",
            description: "Monstros fracos. Ideal para novos aventureiros.",
            monster: { name: "Goblin Fraco", level: 1, baseATK: 1, baseHP: 15, expReward: 10, goldReward: 5 }
        },
        dark_caves: {
            name: "Cavernas Escuras",
            levelRange: "Nv 6 - 10",
            description: "Inimigos mais resistentes. Requer equipamento decente.",
            monster: { name: "Morcego Gigante", level: 6, baseATK: 5, baseHP: 40, expReward: 30, goldReward: 15 }
        },
        ancient_ruins: {
            name: "Ru√≠nas Antigas",
            levelRange: "Nv 11 - 15",
            description: "Criaturas perigosas. Prepare-se para um bom combate.",
            monster: { name: "Esqueleto Guerreiro", level: 11, baseATK: 10, baseHP: 70, expReward: 60, goldReward: 30 }
        }
    };

    let currentZoneKey = 'forest_edge'; // Zona inicial padr√£o.

    // Vari√°veis de Combate
    const EXP_PER_ACTION = 5; 
    const HP_LOSS_FACTOR = 0.5; // Fator de perda de HP: % da diferen√ßa de ATK (simples)

    // ====================================================================
    // III. FUN√á√ïES DE C√ÅLCULO E DISPLAY
    // ====================================================================

    function calculateStats() {
        // 1. Inicializa√ß√£o de Valores Base
        let totalHPBonus = heroBaseHP; 
        let totalATK = heroBaseATK;
        
        // 2. B√¥nus por Equipamento
        for (const slotKey in EQUIPMENT_SLOTS) {
            const item = EQUIPMENT_SLOTS[slotKey].currentItem;
            if (item) {
                totalHPBonus += item.hpBonus || 0;
                totalATK += item.atk || 0;
            }
        }
        
        // 3. B√¥nus por N√≠vel (Simplificado)
        const levelHPBonus = powerLevel * 20; 
        const levelATKBonus = powerLevel * 1; 

        // 4. C√°lculo Final de Status
        heroTotalATK = totalATK + levelATKBonus; 
        heroMaxHP = totalHPBonus + levelHPBonus;
        
        // Garante que o HP atual n√£o ultrapasse o m√°ximo
        heroCurrentHP = Math.min(heroCurrentHP, heroMaxHP);
    }

    function showPanel(panelId) {
        document.querySelectorAll('#content-area > div').forEach(panel => {
            panel.style.display = 'none';
        });
        const panel = document.getElementById(panelId);
        if (panel) {
            panel.style.display = 'block';
        }
        
        // A√ß√£o especial ao entrar no painel de combate (Mapa)
        if (panelId === 'combat-panel') {
            renderAdventureMap();
        }
    }

    function updateDisplay() {
        calculateStats(); // 1. Garante que os stats secund√°rios estejam atualizados
        renderUpgradesPanel(); // 2. Renderiza o painel de Upgrades
        
        // Recursos e N√≠vel
        document.getElementById('power-level-display').textContent = powerLevel;
        document.getElementById('gold-display').textContent = gold;
        document.getElementById('soul-display').textContent = soul;
        document.getElementById('hero-name-display').textContent = heroName;

        // EXP Bar
        const expPercentage = Math.min(100, (currentExp / expToNextLevel) * 100);
        document.getElementById('exp-bar').querySelector('.progress-fill').style.width = `${expPercentage}%`;
        document.getElementById('exp-bar').querySelector('.progress-fill').textContent = `${currentExp}/${expToNextLevel}`;
        
        // HP Bar
        const hpPercentage = Math.min(100, (heroCurrentHP / heroMaxHP) * 100);
        document.getElementById('hp-bar').querySelector('.progress-fill').style.width = `${hpPercentage}%`;
        document.getElementById('hp-bar').querySelector('.progress-fill').textContent = `${heroCurrentHP}/${heroMaxHP}`;
        document.getElementById('hp-current-display').textContent = heroCurrentHP;
        document.getElementById('hp-max-display').textContent = heroMaxHP;
        
        // Stats de Combate no Menu Lateral
        document.getElementById('atk-base-display').textContent = heroBaseATK; // Mostra ATK Base, n√£o Total
        
        // Inventory and Equipment
        renderInventory();
        renderEquipment();
        renderShop();
        
        // Mapa da Aventura (Atualiza o painel de zona mesmo se n√£o estiver vis√≠vel)
        updateCombatPanelInfo();

        if (!gameInitialized) {
            showPanel('creation-panel');
        } else {
            // Se o jogo foi inicializado, certifique-se de que estamos no mapa
            const visiblePanel = Array.from(document.querySelectorAll('#content-area > div')).find(p => p.style.display === 'block');
            if (!visiblePanel || visiblePanel.id === 'creation-panel') {
                showPanel('combat-panel');
            }
        }
    }

    // ====================================================================
    // IV. CRIA√á√ÉO DE PERSONAGEM
    // ====================================================================
    
    function forceCreationPanel() {
         if (confirm("ATEN√á√ÉO: Isso ir√° FOR√áAR a volta para a tela de cria√ß√£o. Se voc√™ continuar, voc√™ pode perder o progresso atual, a menos que o salve. Deseja continuar?")) {
             // Redefine a flag de inicializa√ß√£o e o estado para for√ßar a cria√ß√£o
             gameInitialized = false; 
             selectedClass = null; 
             document.getElementById('class-details-panel').style.display = 'none';
             
             // Limpa o save se o usu√°rio quiser recome√ßar do zero
             localStorage.removeItem('blazeAndSteelSave'); 
             
             // For√ßa a exibi√ß√£o da tela de cria√ß√£o
             showPanel('creation-panel');
         }
    }


    function selectClass(clsKey) {
        document.querySelectorAll('.class-card').forEach(card => {
            card.classList.remove('selected');
        });

        const selectedCard = document.querySelector(`.class-card[data-class="${clsKey}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        const cls = CLASSES[clsKey];
        selectedClass = clsKey;
        
        document.getElementById('selected-class-name').textContent = cls.name;
        document.getElementById('class-description').textContent = cls.description;
        document.getElementById('class-base-hp').textContent = cls.initialHP;
        document.getElementById('class-base-atk').textContent = cls.initialATK;
        
        const startingItemsList = cls.startingItems.map(item => `${item.name} (+${item.atk || item.hpBonus})`).join(', ');
        document.getElementById('class-initial-equipment').textContent = startingItemsList;
        
        document.getElementById('class-details-panel').style.display = 'block';
    }

    function finalizeCreation() {
        const nameInput = document.getElementById('hero-name-input').value.trim();
        if (!nameInput || !selectedClass) {
            alert("Por favor, digite o nome do seu her√≥i e selecione uma classe.");
            return;
        }

        const cls = CLASSES[selectedClass];
        
        // 1. Resetar vari√°veis e definir status iniciais
        heroName = nameInput;
        powerLevel = 1;
        currentExp = 0;
        expToNextLevel = 50;
        gold = 0;
        soul = 0;
        
        // Define o ATK/HP base da classe
        heroBaseHP = cls.initialHP;
        heroBaseATK = cls.initialATK; 

        // HP inicial e total √© calculado
        calculateStats(); 
        heroCurrentHP = heroMaxHP; 

        // 2. Itens Iniciais
        inventory = [];
        for (const slotKey in EQUIPMENT_SLOTS) {
             EQUIPMENT_SLOTS[slotKey].currentItem = null;
        }
        cls.startingItems.forEach(item => {
            addItemToInventory(item, 1, false); 
            if(item.type === 'weapon' || item.type === 'armor') {
                equipItem(item, false);
            }
        });


        // 3. Inicia o Jogo
        gameInitialized = true;
        showPanel('combat-panel');
        saveGame();
        updateDisplay();
        alert(`O her√≥i ${heroName}, o ${cls.name}, come√ßou sua aventura!`);
    }

    // ====================================================================
    // V. MAPA DA AVENTURA E COMBATE (REESCRITO)
    // ====================================================================
    
    /**
     * Renderiza os cart√µes de zona de ca√ßa no painel de combate.
     */
    function renderAdventureMap() {
        const mapContainer = document.getElementById('adventure-map-container');
        mapContainer.innerHTML = '';
        
        for (const key in ZONES) {
            const zone = ZONES[key];
            const card = document.createElement('div');
            card.className = `zone-card ${key === currentZoneKey ? 'selected' : ''}`;
            card.onclick = () => selectZone(key);
            
            card.innerHTML = `
                <h4>${zone.name} (${zone.levelRange})</h4>
                <p>${zone.description}</p>
                <p>Monstro Principal: <strong>${zone.monster.name}</strong> (Recompensa: ${zone.monster.expReward} EXP)</p>
            `;
            mapContainer.appendChild(card);
        }
        updateCombatPanelInfo();
    }
    
    /**
     * Seleciona a zona e atualiza a interface.
     */
    function selectZone(zoneKey) {
        currentZoneKey = zoneKey;
        renderAdventureMap(); // Atualiza a sele√ß√£o visual
    }
    
    /**
     * Atualiza o painel de combate com as informa√ß√µes da zona atual.
     */
    function updateCombatPanelInfo() {
        const zone = ZONES[currentZoneKey];
        if (!zone) return;
        
        const monster = zone.monster;
        
        // C√ÅLCULO DE DANO SIMULADO (Simples: Baseado na diferen√ßa de ATK)
        // Perda de HP ser√° 10% do HP M√°ximo + a diferen√ßa de ATK, para for√ßar o jogador a subir de n√≠vel.
        const effectiveDamageTaken = Math.max(1, Math.floor(heroMaxHP * 0.05 + (monster.baseATK - heroTotalATK)));
        
        document.getElementById('current-zone-name-display').textContent = zone.name;
        document.getElementById('current-monster-name-display').textContent = monster.name;
        document.getElementById('current-monster-level-display').textContent = monster.level;
        document.getElementById('hp-loss-display').textContent = effectiveDamageTaken;

        // Atualiza a mensagem do bot√£o
        document.getElementById('perform-action-button').textContent = `ATACAR ${monster.name} (Perde ${effectiveDamageTaken} HP)`;
    }

    /**
     * Executa a a√ß√£o de combate na zona selecionada.
     */
    function performAction() {
        if (!gameInitialized) return;
        
        const zone = ZONES[currentZoneKey];
        if (!zone) return;
        
        const monster = zone.monster;
        const effectiveDamageTaken = Math.max(1, Math.floor(heroMaxHP * 0.05 + (monster.baseATK - heroTotalATK)));

        if (heroCurrentHP <= effectiveDamageTaken) {
            document.getElementById('combat-log').textContent = "HP insuficiente! Voc√™ est√° muito fraco para lutar aqui. Use uma po√ß√£o ou descanse.";
            return;
        }

        // 1. Simula a perda de HP
        heroCurrentHP -= effectiveDamageTaken;

        // 2. Ganho de Recompensas
        const expGained = monster.expReward;
        const goldGained = monster.goldReward;
        currentExp += expGained;
        gold += goldGained;
        
        document.getElementById('combat-log').textContent = `Voc√™ derrotou um ${monster.name}, ganhou ${expGained} EXP e ${goldGained} Gold. Perdeu ${effectiveDamageTaken} HP.`;
        
        if (currentExp >= expToNextLevel) {
            levelUp();
        }
        
        updateDisplay();
        saveGame();
    }

    function levelUp() {
        if (currentExp < expToNextLevel) {
            return; 
        }
        
        powerLevel++;
        currentExp -= expToNextLevel;
        expToNextLevel = Math.round(expToNextLevel * 1.5);
        
        // Recalcula e restaura o HP
        calculateStats(); 
        heroCurrentHP = heroMaxHP; 

        alert(`üéâ Voc√™ subiu para o N√≠vel ${powerLevel}! HP totalmente restaurado.`);

        updateDisplay();
        saveGame();
    }

    // ====================================================================
    // VI. UPGRADES E TREINAMENTO (MANTIDO)
    // ====================================================================

    function renderUpgradesPanel() {
        document.getElementById('atk-base-upgrade-display').textContent = heroBaseATK;
        document.getElementById('hp-base-upgrade-display').textContent = heroBaseHP;
        document.getElementById('atk-cost-display').textContent = atkUpgradeCost;
        document.getElementById('hp-cost-display').textContent = hpUpgradeCost;
    }

    function buyUpgrade(type) {
        let cost = (type === 'atk') ? atkUpgradeCost : hpUpgradeCost;
        
        if (gold >= cost) {
            gold -= cost;
            if (type === 'atk') {
                heroBaseATK += 1;
                atkUpgradeCost = Math.round(atkUpgradeCost * 1.2); 
            } else if (type === 'hp') {
                heroBaseHP += 10; 
                hpUpgradeCost = Math.round(hpUpgradeCost * 1.2); 
            }
            
            alert(`${type === 'atk' ? 'Ataque Base' : 'HP Base'} melhorado!`);
            calculateStats(); // Recalcula o HP M√°ximo
            updateDisplay();
            saveGame();
        } else {
            alert("Gold insuficiente!");
        }
    }


    // ====================================================================
    // VII. INVENT√ÅRIO, EQUIPAMENTO E LOJA (MANTIDO)
    // ====================================================================

    function addItemToInventory(item, quantity = 1, showAlert = true) {
        const existingItem = inventory.find(i => i.id === item.id);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            inventory.push({ ...item, quantity: quantity });
        }
        renderInventory();
        saveGame();
        if (showAlert) alert(`${item.name} (${quantity}) adicionado ao invent√°rio.`);
    }

    function removeItemFromInventory(item, quantity = 1) {
        const index = inventory.findIndex(i => i.id === item.id);
        if (index !== -1) {
            if (inventory[index].quantity > quantity) {
                inventory[index].quantity -= quantity;
            } else {
                inventory.splice(index, 1);
            }
            renderInventory();
            saveGame();
            return true;
        }
        return false;
    }

    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        grid.innerHTML = '';
        inventory.forEach(item => {
            const slot = document.createElement('div');
            // ... (HTML de slot de invent√°rio)
            slot.className = `item-slot full rarity-${item.rarity.replace(/ /g, '')}`;
            slot.title = item.name;
            slot.onclick = () => inspectItem(item);
            
            slot.innerHTML = `
                <span style="font-size: 24px;">${item.type === 'weapon' ? '‚öîÔ∏è' : item.type === 'armor' ? 'üõ°Ô∏è' : '‚ú®'}</span>
                <span class="item-quantity">${item.quantity}</span>
            `;
            grid.appendChild(slot);
        });
        for(let i = inventory.length; i < 50; i++) {
            const slot = document.createElement('div');
            slot.className = 'item-slot';
            grid.appendChild(slot);
        }
    }

    function renderEquipment() {
        const slotsContainer = document.getElementById('equipment-slots');
        slotsContainer.innerHTML = '';
        for (const key in EQUIPMENT_SLOTS) {
            const slotData = EQUIPMENT_SLOTS[key];
            const slot = document.createElement('div');
            slot.className = 'equipment-slot';
            slot.innerHTML = `<strong>${slotData.name}</strong>`;
            
            if (slotData.currentItem) {
                 const item = slotData.currentItem;
                 slot.className += ` full rarity-${item.rarity.replace(/ /g, '')}`;
                 slot.title = item.name;
                 slot.innerHTML += `<span style="font-size: 24px;">${item.type === 'weapon' ? '‚öîÔ∏è' : item.type === 'armor' ? 'üõ°Ô∏è' : '‚ú®'}</span>`;
                 slot.onclick = () => inspectItem(item);
            }
            slotsContainer.appendChild(slot);
        }
        calculateStats(); // Re-calcula para garantir que os b√¥nus estejam ativos
        updateDisplay(); 
    }
    
    function inspectItem(item) {
        inspectedItem = item;
        const panel = document.getElementById('item-inspection-panel');
        
        document.getElementById('inspected-item-name').textContent = item.name;
        document.getElementById('inspected-item-rarity').textContent = item.rarity;
        document.getElementById('inspected-item-type').textContent = item.type;
        document.getElementById('inspected-item-description').textContent = item.description;
        
        let statsHtml = '';
        if (item.atk) statsHtml += `ATK: +${item.atk}<br>`;
        if (item.hpBonus) statsHtml += `HP M√°x: +${item.hpBonus}<br>`;
        document.getElementById('inspected-item-stats').innerHTML = statsHtml;

        const equipButton = document.getElementById('equip-unequip-button');
        const isEquipped = EQUIPMENT_SLOTS[item.type] && EQUIPMENT_SLOTS[item.type].currentItem && EQUIPMENT_SLOTS[item.type].currentItem.id === item.id;
        
        if (isEquipped) {
            equipButton.textContent = 'DESEQUIPAR';
            equipButton.onclick = () => unequipItem(item);
        } else if (item.type === 'weapon' || item.type === 'armor') {
            equipButton.textContent = 'EQUIPAR';
            equipButton.onclick = () => equipItem(item);
        } else if (item.type === 'consumable') {
            equipButton.textContent = 'USAR';
            equipButton.onclick = () => useItem(item);
        } else {
             equipButton.textContent = '...';
             equipButton.onclick = () => {};
             equipButton.disabled = true;
        }

        panel.style.display = 'block';
    }

    function equipItem(item, showAlert = true) {
        const slotKey = item.type;
        
        if (!EQUIPMENT_SLOTS[slotKey]) {
            if (showAlert) alert(`N√£o h√° slot de equipamento para o tipo: ${slotKey}.`);
            return;
        }

        EQUIPMENT_SLOTS[slotKey].currentItem = item;
        
        renderEquipment();
        renderInventory();
        if (showAlert) inspectItem(item); 
        saveGame();
        if (showAlert) alert(`${item.name} equipado no slot de ${EQUIPMENT_SLOTS[slotKey].name}.`);
    }
    
    function unequipItem(item) {
        const slotKey = item.type;
        
        if (EQUIPMENT_SLOTS[slotKey].currentItem && EQUIPMENT_SLOTS[slotKey].currentItem.id === item.id) {
             EQUIPMENT_SLOTS[slotKey].currentItem = null;
             alert(`${item.name} desequipado.`);
        }
        
        renderEquipment();
        renderInventory();
        if (inspectedItem) {
            inspectItem(inspectedItem); 
        }
        saveGame();
    }
    
    function useItem(item) {
        if (item.type !== 'consumable') {
            alert(`Voc√™ n√£o pode usar ${item.name} desta forma.`);
            return;
        }

        if (removeItemFromInventory(item, 1)) {
            if (item.effect && item.effect.hp) {
                const healAmount = item.effect.hp;
                heroCurrentHP = Math.min(heroCurrentHP + healAmount, heroMaxHP);
                alert(`Voc√™ usou ${item.name} e recuperou ${healAmount} HP.`);
            }
            
            calculateStats();
            updateDisplay();
            saveGame();
        }
    }

    function renderShop() {
        const shopDisplay = document.getElementById('shop-items-display');
        shopDisplay.innerHTML = '';
        
        SHOP_ITEMS.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'content-panel';
            itemDiv.style.border = `2px solid ${item.rarity === 'Raro' ? 'var(--color-evolve)' : 'white'}`;
            itemDiv.innerHTML = `
                <h4>${item.name}</h4>
                <p>${item.description}</p>
                <p>Custo: üí∞ ${item.price} Gold</p>
                <button onclick="buyItem(${item.id})" style="background-color: var(--color-hp); padding: 8px 15px;">Comprar</button>
            `;
            shopDisplay.appendChild(itemDiv);
        });
    }

    function buyItem(itemId) {
        const itemToBuy = SHOP_ITEMS.find(item => item.id === itemId);
        if (!itemToBuy) return;

        if (gold >= itemToBuy.price) {
            gold -= itemToBuy.price;
            addItemToInventory(itemToBuy, 1, true);
            alert(`Voc√™ comprou ${itemToBuy.name} por ${itemToBuy.price} Gold.`);
            updateDisplay();
        } else {
            alert("Gold insuficiente para comprar este item.");
        }
    }


    // ====================================================================
    // VIII. SALVAMENTO E CARREGAMENTO
    // ====================================================================

    function saveGame(showAlert = false) {
        const gameData = {
            gameInitialized: gameInitialized,
            heroName: heroName,
            selectedClass: selectedClass,
            powerLevel: powerLevel,
            currentExp: currentExp,
            expRequired: expToNextLevel,
            gold: gold,
            soul: soul,
            heroCurrentHP: heroCurrentHP,
            
            // Vari√°veis de Status e Upgrades
            heroBaseHP: heroBaseHP,
            heroBaseATK: heroBaseATK,
            atkCost: atkUpgradeCost,
            hpCost: hpUpgradeCost,

            // Novo Mapa
            currentZoneKey: currentZoneKey,

            inventory: inventory,
            equipment: {
                weapon: EQUIPMENT_SLOTS.weapon.currentItem,
                armor: EQUIPMENT_SLOTS.armor.currentItem,
            },
        };
        localStorage.setItem('blazeAndSteelSave', JSON.stringify(gameData));
        if (showAlert) alert("Jogo Salvo!");
    }

    function loadGame(shouldAlert = false) {
        const savedData = localStorage.getItem('blazeAndSteelSave');
        if (savedData) {
            const gameData = JSON.parse(savedData);

            gameInitialized = gameData.gameInitialized || false;
            if (!gameInitialized) return;

            heroName = gameData.heroName || "Her√≥i Desconhecido";
            selectedClass = gameData.selectedClass || null;
            
            // Carrega N√≠vel e Recursos
            powerLevel = gameData.powerLevel || 1;
            currentExp = gameData.currentExp || 0;
            expToNextLevel = gameData.expRequired || 50;
            gold = gameData.gold || 0;
            soul = gameData.soul || 0;
            heroCurrentHP = gameData.heroCurrentHP || 10;
            
            // Carrega Upgrades
            heroBaseHP = gameData.heroBaseHP || 10;
            heroBaseATK = gameData.heroBaseATK || 1;
            atkUpgradeCost = gameData.atkCost || 50;
            hpUpgradeCost = gameData.hpCost || 50;

            // Carrega Mapa
            currentZoneKey = gameData.currentZoneKey || 'forest_edge';

            // Carrega Invent√°rio e Equipamento
            inventory = gameData.inventory || [];
            if (gameData.equipment) {
                EQUIPMENT_SLOTS.weapon.currentItem = gameData.equipment.weapon;
                EQUIPMENT_SLOTS.armor.currentItem = gameData.equipment.armor;
            }

            if (shouldAlert) alert("Jogo Carregado!");
            
            calculateStats();
            updateDisplay();
        }
    }

    function deleteGame(showAlert = false) {
        if (confirm("Tem certeza que deseja REINICIAR o jogo? Todo o progresso ser√° perdido.")) {
            localStorage.removeItem('blazeAndSteelSave');
            gameInitialized = false;
            location.reload(); 
        }
    }
    
    // NOVO: Fun√ß√£o para tentar iniciar a m√∫sica
    function startThemeMusic() {
        const audio = document.getElementById('theme-music');
        if (audio) {
            // Tenta dar play na m√∫sica. Navegadores modernos podem bloquear o autoplay
            // at√© que o usu√°rio interaja com a p√°gina (um clique, por exemplo).
            audio.play().catch(error => {
                console.log("Autoplay bloqueado. O usu√°rio precisa interagir com a p√°gina para iniciar a m√∫sica tema.", error);
            });
        }
    }


    // ====================================================================
    // IX. INICIALIZA√á√ÉO
    // ====================================================================

    loadGame();
    startThemeMusic();
    
</script>

</body>
</html>
