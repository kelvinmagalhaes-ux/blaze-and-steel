<script>

    // ====================================================================
    // I. VARI√ÅVEIS DE ESTADO E CONSTANTES
    // ====================================================================

    // Se a inten√ß√£o for usar uma classe (Lutador), o ideal seria encapsular as vari√°veis abaixo.
    /* class Lutador {
        constructor(name, initialHP, initialATK, initialEnergy) {
            this.heroName = name;
            this.selectedClass = null; // A ser definido na cria√ß√£o
            this.powerLevel = 1;
            this.currentExp = 0;
            this.expToNextLevel = 50;
            this.energy = initialEnergy;
            this.gold = 0;
            this.soul = 0;
            this.heroBaseHP = initialHP;
            this.heroBaseATK = initialATK;
            this.heroCurrentHP = initialHP;
            this.heroMaxHP = initialHP; // <-- ESSENCIAL
            this.energyPerClick = 1;
            this.atkUpgradeCost = 50;
            this.hpUpgradeCost = 50;
            // ... outras propriedades
        }
    }
    */

    // Vari√°veis de Estado (Inicia com valores padr√£o)
    let heroName = "Novo Her√≥i";
    let selectedClass = null;
    let powerLevel = 1;
    let currentExp = 0;
    let expToNextLevel = 50;
    let energy = 0;
    let gold = 0;
    let soul = 0;
    let heroBaseHP = 10;
    let heroBaseATK = 1;
    let heroCurrentHP = 10;
    let heroMaxHP = 10; // CORRE√á√ÉO APLICADA: Declara√ß√£o expl√≠cita de HP M√°ximo.
    let energyPerClick = 1;
    let atkUpgradeCost = 50;
    let hpUpgradeCost = 50;
    let currentMonster = null;
    let isFighting = false;
    let missionInterval = null;
    let inspectedItem = null;
    let nextItemId = 1000;
    
    // Constantes de Jogo
    const DAILY_COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 horas
    const UPGRADE_MULTIPLIER = 1.5;

    // Estrutura para Gerenciar Cooldowns (M√∫ltiplas Miss√µes)
    let missionCooldowns = { provisions: 0, workGold: 0 };

    // Estrutura de Slots de Equipamento (NOVO)
    const EQUIPMENT_SLOTS = {
        weapon: { name: "Arma", type: "weapon", currentItem: null },
        armor: { name: "Armadura", type: "armor", currentItem: null }
    };

    // Estrutura do Invent√°rio (Inicia Vazio para o Novo Jogo)
    let inventory = [];

    // Vari√°veis de √Åudio
    let currentVolume = 1.0; // 0.0 a 1.0
    let hasInteracted = false; // Para controlar o bloqueio de autoplay

    // Estado das Miss√µes
    let dailyMissionStatus = {
        scouting: { completedAt: 0 },
        drills: { completedAt: 0 }
    };
    let uniqueMissionStatus = {
        firstQuest: { completed: false },
        tutorialComplete: { completed: false }
    };

    // Estrutura de Classes do Personagem (ATUALIZADA com startingItems)
    const CLASSES = {
        warrior: {
            name: "Guerreiro",
            description: "Especialista em combate corpo-a-corpo, focado em vida e dano balanceado.",
            initialHP: 15,
            initialATK: 2,
            initialEnergy: 50,
            imagePath: "assets/guerreiro.png",
            startingItems: [
                { id: 1, name: "Espada Curta", type: "weapon", atk: 2, rarity: "Comum", description: "Uma l√¢mina b√°sica de treinamento." },
                { id: 2, name: "Armadura de Couro", type: "armor", hpBonus: 10, rarity: "Comum", description: "Prote√ß√£o leve e confi√°vel." }
            ]
        },
        mage: {
            name: "Mago",
            description: "Fr√°gil, mas com alto potencial de dano m√°gico e grande reserva de energia.",
            initialHP: 8,
            initialATK: 1,
            initialEnergy: 150,
            imagePath: "assets/mago.png",
            startingItems: [
                { id: 3, name: "Cajado de Madeira", type: "weapon", atk: 1, energyBonus: 50, rarity: "Comum", description: "Um cajado simples para canalizar magia." },
                { id: 4, name: "Manto de Pano", type: "armor", hpBonus: 5, rarity: "Comum", description: "Roupas leves que n√£o atrapalham o movimento." }
            ]
        },
        archer: {
            name: "Arqueiro",
            description: "R√°pido e preciso, com bom equil√≠brio entre ataque e defesa.",
            initialHP: 10,
            initialATK: 1,
            initialEnergy: 100,
            imagePath: "assets/arqueiro.png",
            startingItems: [
                { id: 5, name: "Arco Simples", type: "weapon", atk: 1, rarity: "Comum", description: "Um arco confi√°vel para ca√ßa e combate." },
                { id: 6, name: "Cota de Malha Leve", type: "armor", hpBonus: 15, rarity: "Comum", description: "Prote√ß√£o que n√£o compromete a agilidade." }
            ]
        }
    };

    // Objeto central para a sele√ß√£o de monstros por N√≠vel
    const MONSTERS_BY_LEVEL = {
        1: [
            { name: "Slime Iniciante", baseHP: 20, atk: 2, expReward: 30, goldReward: 5, energyCost: 5 },
            { name: "Mosquito Mutante", baseHP: 15, atk: 3, expReward: 35, goldReward: 6, energyCost: 5 }
        ],
        2: [
            { name: "Lobo Faminto", baseHP: 45, atk: 8, expReward: 70, goldReward: 15, energyCost: 7 },
            { name: "Cogumelo Venenoso", baseHP: 60, atk: 5, expReward: 65, goldReward: 12, energyCost: 7 }
        ],
        3: [
            { name: "Bandido de Estrada", baseHP: 80, atk: 12, expReward: 120, goldReward: 25, energyCost: 10 },
            { name: "Golem de Pedra Pequeno", baseHP: 150, atk: 5, expReward: 110, goldReward: 20, energyCost: 10 }
        ]
    };


    // ====================================================================
    // II. REFER√äNCIAS DO DOM
    // ====================================================================

    // Refer√™ncias do DOM
    const startMenu = document.getElementById('start-menu');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');

    // Display de Recursos e N√≠vel
    const powerLevelDisplay = document.getElementById('power-level-display');
    const energyCount = document.getElementById('energy-count');
    const goldCount = document.getElementById('gold-count');
    const soulCount = document.getElementById('soul-count');
    const expCount = document.getElementById('exp-count');
    const expRequired = document.getElementById('exp-required');
    const levelUpButton = document.getElementById('level-up-button');

    // Refer√™ncias de NOME e T√çTULO
    const heroNameInput = document.getElementById('hero-name-input');
    const heroNameDisplay = document.getElementById('hero-name');
    const headerTitle = document.querySelector('#header h2');

    // Refer√™ncias do Painel de Cria√ß√£o
    const characterCreationPanel = document.getElementById('character-creation-panel');
    const classContainer = document.getElementById('class-selection-container');
    const classDetails = document.getElementById('class-details');
    const confirmCreationButton = document.getElementById('confirm-creation-button');
    const selectedClassName = document.getElementById('selected-class-name');
    const classBaseHp = document.getElementById('class-base-hp');
    const classBaseAtk = document.getElementById('class-base-atk');
    const classInitialEnergy = document.getElementById('class-initial-energy');
    const classInitialEquipment = document.getElementById('class-initial-equipment');

    // Refer√™ncias de √Åudio
    const gameThemeMusic = document.getElementById('game-theme-music');
    const audioControlButton = document.getElementById('audio-control-button');
    const volumeSliderStart = document.getElementById('volume-slider-start');
    const volumeLabelStart = document.getElementById('volume-label-start');
    const volumeSliderGame = document.getElementById('volume-slider-game');
    const volumeLabelGame = document.getElementById('volume-label-game');


    // Refer√™ncias de Upgrades
    const upgradeAtkDisplay = document.getElementById('upgrade-atk-display');
    const atkCostDisplay = document.getElementById('atk-cost');
    const buyAtkUpgradeButton = document.getElementById('buy-atk-upgrade');
    const upgradeHpDisplay = document.getElementById('upgrade-hp-display');
    const hpCostDisplay = document.getElementById('hp-cost');
    const buyHpUpgradeButton = document.getElementById('buy-hp-upgrade');

    // Refer√™ncias de Combate
    const monsterNameDisplay = document.getElementById('monster-name');
    const heroCurrentHPDisplay = document.getElementById('hero-current-hp');
    const heroMaxHPDisplay = document.getElementById('hero-max-hp');
    const heroTotalATKDisplay = document.getElementById('hero-total-atk');
    const heroLevelMultiplierDisplay = document.getElementById('hero-level-multiplier');
    const startBattleButton = document.getElementById('start-battle-button');
    const combatLog = document.getElementById('combat-log');

    // Refer√™ncias de Invent√°rio e Equipamento
    const inventoryPanel = document.getElementById('inventory-panel');
    const itemDetailsPanel = document.getElementById('item-details-panel');
    const equipmentPanel = document.getElementById('equipment-list');
    const heroStatsEquipment = document.getElementById('hero-stats-equipment');

    // ====================================================================
    // III. FUN√á√ïES DE DISPLAY E UTILIDADE
    // ====================================================================

    // Atualiza a exibi√ß√£o na tela
    function updateDisplay() {
        // NOME
        heroNameDisplay.textContent = heroName;
        headerTitle.textContent = heroName;

        // Recursos
        powerLevelDisplay.textContent = powerLevel;
        document.getElementById('power-level').textContent = powerLevel;
        energyCount.textContent = energy;
        goldCount.textContent = gold;
        soulCount.textContent = soul;
        expCount.textContent = currentExp;
        expRequired.textContent = expToNextLevel;

        // Level Up
        if (currentExp >= expToNextLevel) {
            levelUpButton.disabled = false;
            levelUpButton.textContent = 'SUBIR DE N√çVEL';
        } else {
            levelUpButton.disabled = true;
            levelUpButton.textContent = `SUBIR DE N√çVEL (Falta: ${expToNextLevel - currentExp} EXP)`;
        }

        // Upgrades
        upgradeAtkDisplay.textContent = heroBaseATK;
        atkCostDisplay.textContent = atkUpgradeCost;
        upgradeHpDisplay.textContent = heroBaseHP;
        hpCostDisplay.textContent = hpUpgradeCost;
        buyAtkUpgradeButton.disabled = gold < atkUpgradeCost;
        buyHpUpgradeButton.disabled = gold < hpUpgradeCost;

        // Miss√µes
        updateMissionButtons();

        // === ATUALIZA√á√ÉO PARA COMBATE (CHAMA updateEquipmentStats) ===
        updateEquipmentStats(); // <-- Garante que o HP/ATK total reflita o equipamento

        // === ATUALIZA√á√ÉO DO PAINEL AVENTURA ===
        updateAdventurePanel();

        // === ATUALIZA√á√ÉO DO VOLUME E MUTE ===
        const volValue = Math.round(currentVolume * 100);
        if (volumeSliderStart) {
            volumeSliderStart.value = volValue;
            volumeLabelStart.textContent = volValue;
        }
        if (volumeSliderGame) {
            volumeSliderGame.value = volValue;
            volumeLabelGame.textContent = volValue;
        }
        audioControlButton.textContent = gameThemeMusic.muted ? 'üîá Unmute' : 'üîä Mute';
    }

    // Atualiza o estado dos bot√µes de Miss√µes Di√°rias e √önicas
    function updateMissionButtons() {
        const now = Date.now();
        
        // Di√°rias
        for (const key in dailyMissionStatus) {
            const status = dailyMissionStatus[key];
            const button = document.getElementById(`daily-${key}`);
            if (!button) continue; 
            
            if (now < status.completedAt + DAILY_COOLDOWN_MS) {
                const timeLeft = Math.ceil((status.completedAt + DAILY_COOLDOWN_MS - now) / (1000 * 60)); // Minutos
                button.disabled = true;
                button.textContent = `Em Cooldown (${timeLeft} min)`;
            } else {
                button.disabled = false;
                // Restaura o texto original (precisa ser feito manualmente ou buscado no CLASSES)
                if (key === 'scouting') button.textContent = `Fazer Patrulha (Recompensa: 100 EXP | 50 üí∞)`;
                else if (key === 'drills') button.textContent = `Exerc√≠cios de Treinamento (Recompensa: 200 EXP | +2 ATK B√¥nus!)`;
            }
        }
        
        // √önicas
        for (const key in uniqueMissionStatus) {
            const status = uniqueMissionStatus[key];
            const button = document.getElementById(`unique-${key}`);
            if (!button) continue; 
            
            if (status.completed) {
                button.disabled = true;
                button.textContent = `Conclu√≠da!`;
                button.style.display = 'none'; // Esconde ap√≥s completar
            } else {
                button.disabled = false;
            }
        }
    }

    // Atualiza o painel de Aventura (seleciona um monstro e atualiza o display)
    function updateAdventurePanel() {
        // Se j√° estivermos em combate, n√£o faz nada
        if (isFighting) return;

        // Se currentMonster for nulo, selecione um monstro
        if (!currentMonster) {
            selectMonsterByLevel();
        }

        // Se ainda for nulo (pode n√£o haver monstros para o n√≠vel), desabilita a batalha
        if (!currentMonster) {
            document.getElementById('monster-name').textContent = "---";
            document.getElementById('monster-hp-display').textContent = "0";
            document.getElementById('monster-atk-display').textContent = "0";
            document.getElementById('monster-reward-exp').textContent = "0";
            document.getElementById('monster-reward-gold').textContent = "0";
            startBattleButton.textContent = "Nenhum Monstro Aqui";
            startBattleButton.disabled = true;
            return;
        }

        // Atualiza informa√ß√µes do monstro
        document.getElementById('monster-name').textContent = currentMonster.name;
        document.getElementById('monster-hp-display').textContent = currentMonster.currentHP;
        document.getElementById('monster-atk-display').textContent = currentMonster.atk;
        document.getElementById('monster-reward-exp').textContent = currentMonster.expReward;
        document.getElementById('monster-reward-gold').textContent = currentMonster.goldReward;
        startBattleButton.textContent = `Iniciar Batalha! (Custo: ${currentMonster.energyCost} ‚ö°)`;

        // Garante que o bot√£o de batalha esteja no estado correto
        startBattleButton.disabled = energy < currentMonster.energyCost || isFighting;
    }

    // Exibe o painel de Cria√ß√£o de Personagem
    function showCharacterCreation() {
        // *** A√á√ÉO DE CORRE√á√ÉO (√Åudio) ***
        hasInteracted = true;
        checkAndPlayMusic();

        // Esconde o menu inicial
        startMenu.style.display = 'none';
        // Esconde a sidebar e o conte√∫do principal do jogo
        sidebar.style.display = 'none';
        mainContent.style.display = 'none';

        // Reseta a vari√°vel de classe para for√ßar a sele√ß√£o
        selectedClass = null;

        // Exibe APENAS a tela de cria√ß√£o
        characterCreationPanel.style.display = 'flex';
        generateClassButtons();
    }

    // Gera os bot√µes de sele√ß√£o de classe no painel
    function generateClassButtons() {
        classContainer.innerHTML = '';
        for (const key in CLASSES) {
            const cls = CLASSES[key];
            const button = document.createElement('button');
            button.textContent = cls.name;
            button.setAttribute('data-class-key', key);
            button.onclick = () => selectClass(key);
            
            const img = document.createElement('img');
            img.src = cls.imagePath;
            img.alt = `√çcone de ${cls.name}`;
            button.prepend(img); 

            classContainer.appendChild(button);
        }
    }

    // L√≥gica de sele√ß√£o de classe
    function selectClass(key) {
        selectedClass = key;
        const cls = CLASSES[key];
        
        // Atualiza o display de detalhes
        selectedClassName.textContent = cls.name;
        classBaseHp.textContent = cls.initialHP;
        classBaseAtk.textContent = cls.initialATK;
        classInitialEnergy.textContent = cls.initialEnergy;
        classInitialEquipment.textContent = cls.startingItems.map(i => i.name).join(', ');
        
        // Exibe o painel de detalhes e habilita o bot√£o de confirma√ß√£o
        classDetails.style.display = 'block';
        confirmCreationButton.disabled = false;
        
        // Remove a sele√ß√£o de todos os bot√µes e aplica ao selecionado
        document.querySelectorAll('#class-selection-container button').forEach(btn => {
            btn.style.border = '2px solid var(--color-primary)';
        });
        document.querySelector(`button[data-class-key="${key}"]`).style.border = '2px solid var(--color-energy)';
    }

    // Finaliza a cria√ß√£o e inicia o jogo
    function finalizeCreation() {
        if (!selectedClass) {
            alert("Por favor, selecione uma classe.");
            return;
        }

        const cls = CLASSES[selectedClass];

        // 1. Reseta o estado para a classe escolhida
        heroBaseHP = cls.initialHP;
        heroBaseATK = cls.initialATK;
        heroCurrentHP = cls.initialHP;
        energy = cls.initialEnergy;
        heroMaxHP = cls.initialHP; // Garante que o maxHP √© o inicial
        powerLevel = 1;
        currentExp = 0;
        expToNextLevel = 50;
        gold = 0;
        inventory = []; // Zera o invent√°rio
        // Zera slots de equipamento
        for (const slotKey in EQUIPMENT_SLOTS) {
            EQUIPMENT_SLOTS[slotKey].currentItem = null;
        }

        // 2. Define o nome do her√≥i
        const chosenName = heroNameInput.value.trim();
        if (chosenName) {
            heroName = chosenName;
        } else {
            heroName = `Her√≥i ${cls.name}`;
        }

        // 3. Adiciona e Equipa os Itens Iniciais (NOVA L√ìGICA)
        cls.startingItems.forEach((starterItem, index) => {
            // Cria uma c√≥pia do item para que IDs de itens sejam √∫nicos em saves
            const newItem = { 
                ...starterItem, 
                id: nextItemId++, // Usa um ID incremental √∫nico para o item
                // Adiciona a raridade se n√£o existir (para o display)
                rarity: starterItem.rarity || "B√°sico" 
            };
            inventory.push(newItem); // Adiciona ao invent√°rio
            equipItem(newItem, false); // Equipa o item (sem alerta, para n√£o floodar)
        });


        // 4. Inicia o jogo
        characterCreationPanel.style.display = 'none'; // Esconde a tela de cria√ß√£o
        startGame(); // CHAMA A FUN√á√ÉO PARA INICIAR O JOGO
        saveGame(); // Salva o novo jogo
    }

    // Inicia o jogo ap√≥s cria√ß√£o ou carregamento
    function startGame() {
        sidebar.style.display = 'block';
        mainContent.style.display = 'block'; // Exibe o conte√∫do principal
        showPanel('training-panel');
        updateDisplay();
    }

    // Alterna entre os pain√©is de conte√∫do (ATUALIZADO)
    function showPanel(panelId) {
        const panels = document.querySelectorAll('#content-area > div');
        panels.forEach(panel => {
            panel.style.display = 'none';
        });

        document.getElementById(panelId).style.display = 'block';
        
        // Atualiza a classe 'active' na sidebar
        document.querySelectorAll('.sidebar-menu button').forEach(button => {
            button.classList.remove('active');
        });
        document.getElementById(`btn-${panelId.replace('-panel', '')}`).classList.add('active');

        // Seleciona um novo monstro ao entrar no painel de aventura
        if (panelId === 'adventure-panel') {
            selectMonsterByLevel();
        }

        updateDisplay();
        
        // Se for o painel de equipamento/invent√°rio, renderiza
        if (panelId === 'equipment-panel') {
            renderEquipment();
        }
        if (panelId === 'inventory-panel') {
            renderInventory();
        }
    }


    // ====================================================================
    // IV. FUN√á√ïES DE √ÅUDIO
    // ====================================================================

    // Tenta tocar a m√∫sica, respeitando as restri√ß√µes de autoplay
    function checkAndPlayMusic() {
        // Tenta tocar se o usu√°rio j√° interagiu E se a m√∫sica est√° pausada E n√£o est√° mutada
        if (hasInteracted && gameThemeMusic.paused && !gameThemeMusic.muted) {
            gameThemeMusic.play().catch(error => {
                // Se houver erro de autoplay, simplesmente deixa quieto
                console.log("Autoplay bloqueado. A m√∫sica come√ßar√° na primeira intera√ß√£o.");
            });
        }
    }

    // Define o volume e atualiza o estado de mute
    function setVolume(vol) {
        const newVolume = parseInt(vol) / 100;
        currentVolume = newVolume;
        gameThemeMusic.volume = newVolume;

        // Mute o √°udio
        if (vol == 0) {
            gameThemeMusic.muted = true;
        } else if (gameThemeMusic.muted && vol > 0) {
            // Se estava mutado (pelo bot√£o) e aumentou o volume, desmute
            gameThemeMusic.muted = false;
            // Se aumentou o volume, tenta tocar
            hasInteracted = true;
            checkAndPlayMusic();
        }

        // Salva o volume e o estado do mute
        localStorage.setItem('gameVolume', vol);
        localStorage.setItem('isMuted', gameThemeMusic.muted);
        updateDisplay();
    }

    // Alterna entre Mute e Unmute
    function toggleMute() {
        // Se o volume estiver em 0, n√£o faz sentido desmutar
        if (currentVolume === 0 && gameThemeMusic.muted) {
            alert("Volume est√° em 0. Por favor, aumente o volume para ouvir.");
            return;
        }

        gameThemeMusic.muted = !gameThemeMusic.muted;

        // Se tentar desmutar e a m√∫sica n√£o estiver tocando, tenta dar play
        if (!gameThemeMusic.muted && gameThemeMusic.paused) {
            hasInteracted = true; // Garante que a intera√ß√£o est√° registrada
            checkAndPlayMusic();
        }

        localStorage.setItem('isMuted', gameThemeMusic.muted);
        updateDisplay();
    }


    // ====================================================================
    // V. FUN√á√ïES DE SALVAR/CARREGAR (localStorage)
    // ====================================================================

    // Salva o Estado do Jogo no Navegador (ATUALIZADO)
    function saveGame() {
        const gameData = {
            heroName: heroName,
            selectedClass: selectedClass,
            level: powerLevel,
            exp: currentExp,
            expRequired: expToNextLevel,
            energy: energy,
            gold: gold,
            soul: soul,
            
            // Upgrades
            energyPerClick: energyPerClick,
            heroHP: heroBaseHP,
            heroATK: heroBaseATK,
            atkCost: atkUpgradeCost,
            hpCost: hpUpgradeCost,

            // Status de Combate
            heroCurrentHP: heroCurrentHP,

            // Status de Miss√µes
            dailyStatus: dailyMissionStatus,
            uniqueStatus: uniqueMissionStatus,
            missionCooldowns: missionCooldowns,

            // Itens e Equipamento (NOVO)
            inventory: inventory,
            equipment: EQUIPMENT_SLOTS,
            nextItemId: nextItemId,
        };
        localStorage.setItem('gameData', JSON.stringify(gameData));
        console.log("Jogo Salvo!");
    }

    // Carrega o Estado do Jogo
    function loadGame(alertOnFail = false) {
        const savedData = localStorage.getItem('gameData');
        
        // Carrega as configura√ß√µes de √°udio (Sempre deve carregar)
        const savedVolume = localStorage.getItem('gameVolume');
        const savedMute = localStorage.getItem('isMuted');

        if (savedVolume !== null) {
            currentVolume = parseInt(savedVolume) / 100;
            gameThemeMusic.volume = currentVolume;
        }
        if (savedMute !== null) {
            gameThemeMusic.muted = savedMute === 'true';
        }
        
        updateDisplay(); // Atualiza os controles de volume

        if (savedData) {
            const gameData = JSON.parse(savedData);

            // Carrega vari√°veis principais
            heroName = gameData.heroName || "Her√≥i Desconhecido";
            selectedClass = gameData.selectedClass || 'warrior';
            powerLevel = gameData.level || 1;
            currentExp = gameData.exp || 0;
            expToNextLevel = gameData.expRequired || 50;
            energy = gameData.energy || 0;
            gold = gameData.gold || 0;
            soul = gameData.soul || 0;

            // Carrega Upgrades
            energyPerClick = gameData.energyPerClick || 1;
            heroBaseHP = gameData.heroHP || 10;
            heroBaseATK = gameData.heroATK || 1;
            atkUpgradeCost = gameData.atkCost || 50;
            hpUpgradeCost = gameData.hpCost || 50;
            
            // Carrega Status de Combate
            heroCurrentHP = gameData.heroCurrentHP || heroBaseHP;
            heroMaxHP = heroBaseHP; // Ser√° corrigido em updateEquipmentStats

            // Carrega Status de Miss√µes
            dailyMissionStatus = gameData.dailyStatus || dailyMissionStatus;
            uniqueMissionStatus = gameData.uniqueStatus || uniqueMissionStatus;
            missionCooldowns = gameData.missionCooldowns || { provisions: 0, workGold: 0 };
            
            // NOVO: Carrega Itens e Equipamento
            inventory = gameData.inventory || [];
            nextItemId = gameData.nextItemId || 1000;
            
            if (gameData.equipment) {
                for (const slotKey in gameData.equipment) {
                    if (EQUIPMENT_SLOTS[slotKey]) {
                        // √â crucial que o item carregado do save seja uma refer√™ncia ao objeto no invent√°rio
                        const equippedItemId = gameData.equipment[slotKey].currentItem ? 
                                                gameData.equipment[slotKey].currentItem.id : null;
                        
                        if (equippedItemId) {
                            // Encontra a refer√™ncia do item no invent√°rio
                            const itemReference = inventory.find(item => item.id === equippedItemId);
                            
                            if (itemReference) {
                                EQUIPMENT_SLOTS[slotKey].currentItem = itemReference;
                            } else {
                                // Caso o item n√£o seja encontrado (bug de save), desequipa
                                EQUIPMENT_SLOTS[slotKey].currentItem = null; 
                            }
                        } else {
                            EQUIPMENT_SLOTS[slotKey].currentItem = null;
                        }
                    }
                }
            }


            // Esconde o menu inicial e inicia o jogo
            startMenu.style.display = 'none';
            startGame();
            console.log("Jogo Carregado!");
            return true;
        } else {
            if (alertOnFail) {
                alert("Nenhum jogo salvo encontrado!");
            }
            // Garante que o menu inicial est√° vis√≠vel se n√£o houver jogo salvo
            startMenu.style.display = 'flex';
            sidebar.style.display = 'none';
            mainContent.style.display = 'none';
            updateDisplay();
            return false;
        }
    }


    // ====================================================================
    // VI. FUN√á√ïES DE PROGRESSO
    // ====================================================================

    // 1. L√≥gica de Level Up (Chamada ap√≥s ganhar EXP e em finalizeCreation)
    function levelUp() {
        while (currentExp >= expToNextLevel) {
            powerLevel++;
            currentExp -= expToNextLevel;
            
            // Calcula EXP para o pr√≥ximo n√≠vel (Exemplo: (Nivel * 50) + 50)
            expToNextLevel = (powerLevel * 50) + 50; 
            
            // Aumenta o ATK e HP base por n√≠vel
            heroBaseATK += 1;
            heroBaseHP += 5;
            heroCurrentHP = heroMaxHP; // Cura o her√≥i ao subir de n√≠vel
            
            alert(`üéâ Parab√©ns! Voc√™ alcan√ßou o N√≠vel ${powerLevel}! Seu HP e ATK foram aumentados.`);
        }
        updateDisplay();
        saveGame();
    }


    // 2. Comprar Upgrades
    function buyUpgrade(type) {
        if (type === 'atk' && gold >= atkUpgradeCost) {
            gold -= atkUpgradeCost;
            heroBaseATK += 1;
            atkUpgradeCost = Math.round(atkUpgradeCost * UPGRADE_MULTIPLIER);
            alert(`‚öîÔ∏è Ataque Base (Upgrade) aumentado para ${heroBaseATK}!`);
        } else if (type === 'hp' && gold >= hpUpgradeCost) {
            gold -= hpUpgradeCost;
            heroBaseHP += 10;
            hpUpgradeCost = Math.round(hpUpgradeCost * UPGRADE_MULTIPLIER);
            alert(`‚ù§Ô∏è HP Base (Upgrade) aumentado para ${heroBaseHP}!`);
        } else {
            alert("Voc√™ n√£o tem Ouro suficiente para este upgrade!");
            return;
        }
        updateDisplay();
        saveGame();
    }

    // 3. In√≠cio de Miss√µes Recorrentes (Cooldowns de Tempo)
    function startMission(missionType, initialDuration = 0) {
        if (missionCooldowns[missionType] > 0 && initialDuration === 0) {
            alert(`Espere! A miss√£o ainda est√° em cooldown.`);
            return;
        }

        let duration = initialDuration > 0 ? initialDuration : 0;
        let rewards = {};
        let button = null;
        let buttonText = '';

        if (missionType === 'provisions') {
            duration = 30;
            rewards = { energy: 50 };
            button = document.getElementById('provisions-button');
            buttonText = `Coletar Provis√µes (30s | Ganho: 50 ‚ö°)`;
        } else if (missionType === 'workGold') {
            duration = 60;
            rewards = { gold: 20 };
            button = document.getElementById('work-gold-button');
            buttonText = `Trabalhar por Ouro (60s | Ganho: 20 üí∞)`;
        }

        if (duration === 0) return;

        // Inicia Cooldown
        missionCooldowns[missionType] = duration;
        button.disabled = true;
        
        // Fun√ß√£o de Atualiza√ß√£o
        const updateCooldown = () => {
            if (missionCooldowns[missionType] > 0) {
                missionCooldowns[missionType]--;
                button.textContent = `Em andamento... (${missionCooldowns[missionType]}s)`;
            } else {
                clearInterval(missionIntervals[missionType]);
                button.disabled = false;
                button.textContent = buttonText;
                
                // Aplica Recompensas
                energy += rewards.energy || 0;
                gold += rewards.gold || 0;
                
                alert(`Miss√£o de ${missionType} conclu√≠da! Recompensas recebidas.`);
                updateDisplay();
                saveGame();
            }
        };

        // Inicia o intervalo de 1 segundo
        let missionIntervals = {};
        missionIntervals[missionType] = setInterval(updateCooldown, 1000);
        
        // Executa a primeira atualiza√ß√£o imediatamente
        updateCooldown();
    }


    // 4. Treinar para EXP
    function trainForStats(type) {
        const cost = 25;
        const expGain = 10;
        
        if (energy < cost) {
            alert(`Energia insuficiente! Voc√™ precisa de ${cost} ‚ö° para treinar.`);
            return;
        }

        energy -= cost;
        currentExp += expGain;
        
        alert(`Voc√™ treinou ${type} e ganhou ${expGain} EXP!`);

        updateDisplay();
        levelUp(); // Tenta subir de n√≠vel
        saveGame();
    }

    // 5. In√≠cio de Miss√µes Di√°rias (24h de Cooldown)
    function startDailyMission(key) {
        const status = dailyMissionStatus[key];
        const now = Date.now();
        
        if (now < status.completedAt + DAILY_COOLDOWN_MS) {
            alert("Essa miss√£o s√≥ pode ser feita uma vez por dia!");
            return;
        }

        status.completedAt = now;
        let message = "Miss√£o Di√°ria completa!";

        if (key === 'scouting') {
            currentExp += 100;
            gold += 50;
            message += " Recompensa: 100 EXP e 50 üí∞!";
        } else if (key === 'drills') {
            currentExp += 200;
            heroBaseATK += 2;
            message += " Recompensa: 200 EXP e +2 ATK base!";
        }

        alert(message);
        updateDisplay();
        levelUp();
        saveGame();
    }

    // 6. In√≠cio de Miss√µes √önicas (Desaparecem ap√≥s completar)
    function startUniqueMission(key) {
        const status = uniqueMissionStatus[key];
        if (status.completed) {
            return;
        }
        
        status.completed = true;
        let message = "Miss√£o √önica conclu√≠da!";

        if (key === 'firstQuest') {
            currentExp += 500;
            heroBaseHP += 10;
            heroCurrentHP += 10; // Aumenta o HP atual tamb√©m
            message += " Recompensa: 500 EXP e +10 HP base!";
        } else if (key === 'tutorialComplete') {
            gold += 100;
            energy += 100;
            message += " Recompensa: 100 üí∞ e 100 ‚ö°!";
        }

        alert(message);
        updateDisplay();
        levelUp();
        saveGame();
    }

    // ====================================================================
    // VII. FUN√á√ïES DE COMBATE
    // ====================================================================

    // Seleciona um monstro com base no n√≠vel do her√≥i
    function selectMonsterByLevel() {
        const level = powerLevel;
        
        // Encontra o grupo de monstros do n√≠vel mais pr√≥ximo (que n√£o seja maior que o atual)
        let monsters = [];
        for (let l = level; l >= 1; l--) {
            if (MONSTERS_BY_LEVEL[l]) {
                monsters = MONSTERS_BY_LEVEL[l];
                break;
            }
        }
        
        if (monsters.length === 0) {
            // Se n√£o houver monstros, define como nulo
            currentMonster = null;
            return;
        }

        // Seleciona um monstro aleatoriamente do grupo
        const monsterTemplate = monsters[Math.floor(Math.random() * monsters.length)];

        // Cria uma C√ìPIA do monstro para que o HP atual seja √∫nico para a luta
        currentMonster = {
            ...monsterTemplate,
            currentHP: monsterTemplate.baseHP 
        };

        // Aplica um pequeno fator de aleatoriedade no HP
        const hpVariance = Math.floor(Math.random() * (monsterTemplate.baseHP * 0.1)); // +/- 10%
        currentMonster.baseHP += hpVariance;
        currentMonster.currentHP += hpVariance;

        updateAdventurePanel(); // Atualiza a exibi√ß√£o com o novo monstro
    }


    function logToCombat(message) {
        const p = document.createElement('p');
        p.innerHTML = message;
        combatLog.appendChild(p);
        // Garante que o log role para o final
        combatLog.scrollTop = combatLog.scrollHeight;
    }

    // L√≥gica de Combate
    function startBattle() {
        if (!currentMonster) {
            logToCombat("N√£o h√° monstro para lutar. Tente mudar de painel e voltar!");
            return;
        }
        
        const energyCost = currentMonster.energyCost;
        
        if (isFighting) {
            alert("A batalha j√° est√° em andamento!");
            return;
        }

        if (energy < energyCost) {
            alert(`Energia insuficiente! Voc√™ precisa de ${energyCost} ‚ö° para entrar em combate.`);
            return;
        }
        
        // 1. Inicia Batalha
        energy -= energyCost;
        isFighting = true;
        startBattleButton.textContent = 'Em Combate...';
        startBattleButton.disabled = true;

        // Restaura HP do monstro para a base a cada nova luta
        currentMonster.currentHP = currentMonster.baseHP;

        // Recalcula ATK Total do Her√≥i (buscando o valor do display, que j√° inclui equipamento)
        let heroATK = parseInt(document.getElementById('eq-total-atk').textContent) || heroBaseATK;

        // Limpa Log
        combatLog.innerHTML = `<p style="font-weight: bold;">[Batalha Iniciada contra ${currentMonster.name}]</p>`;
        logToCombat(`<p style="color: var(--color-energy);">Her√≥i consome ${energyCost} ‚ö° e se prepara para lutar!</p>`);
        
        // 2. Loop de Turnos (Simula√ß√£o)
        let turn = 1;
        const battleInterval = setInterval(() => {
            
            // Fim da Batalha (Verificado no in√≠cio de cada turno)
            if (currentMonster.currentHP <= 0 || heroCurrentHP <= 0) {
                clearInterval(battleInterval);
                endBattle(currentMonster.currentHP <= 0);
                return;
            }

            // --- Turno do Her√≥i ---
            // O dano base √© multiplicado pelo N√≠vel (o multiplicador xN√≠vel √© o nosso 'power curve')
            // Multiplicador de N√≠vel: (1 + 0.2 por n√≠vel acima do 1)
            const levelMultiplier = powerLevel > 0 ? (1 + (powerLevel - 1) * 0.2) : 1;
            const heroDamage = Math.floor(heroATK * levelMultiplier) + Math.floor(Math.random() * heroATK * 0.1); // Dano com varia√ß√£o
            currentMonster.currentHP -= heroDamage;

            logToCombat(`<p style="color: var(--color-evolve);">[Turno ${turn}] Her√≥i ataca e causa ${heroDamage} de dano! (HP Monstro: ${Math.max(0, currentMonster.currentHP)}/${currentMonster.baseHP})</p>`);

            // Verifica novamente se o monstro morreu
            if (currentMonster.currentHP <= 0) return;

            // --- Turno do Monstro ---
            const monsterDamage = currentMonster.atk + Math.floor(Math.random() * currentMonster.atk * 0.1);
            heroCurrentHP -= monsterDamage;

            logToCombat(`<p style="color: var(--color-combat);">[Turno ${turn}] ${currentMonster.name} ataca e causa ${monsterDamage} de dano! (HP Her√≥i: ${Math.max(0, heroCurrentHP)}/${heroMaxHP})</p>`);
            
            // Atualiza o display de HP do her√≥i
            heroCurrentHPDisplay.textContent = Math.max(0, heroCurrentHP);
            
            turn++;

        }, 1500); // 1.5 segundo por turno

        saveGame();
        updateDisplay(); 
    }

    // L√≥gica de Fim de Batalha
    function endBattle(win) {
        isFighting = false;
        startBattleButton.textContent = 'Iniciar Batalha! (Custo: 5 ‚ö°)';
        startBattleButton.disabled = false;
        
        if (win) {
            // Se Ganhou
            currentExp += currentMonster.expReward;
            gold += currentMonster.goldReward;
            soul += 1; // Ganho fixo de Alma por vit√≥ria

            logToCombat(`<p style="color: var(--color-hp); font-weight: bold;">[VIT√ìRIA!] Voc√™ derrotou o ${currentMonster.name}!</p>`);
            logToCombat(`Recompensas: ${currentMonster.expReward} EXP, ${currentMonster.goldReward} üí∞, 1 üíÄ.`);

            levelUp();
        } else {
            // Se Perdeu
            const goldLoss = Math.floor(gold * 0.1);
            gold = Math.max(0, gold - goldLoss);
            heroCurrentHP = heroMaxHP; // Restaura HP do her√≥i ap√≥s derrota
            logToCombat(`<p style="color: var(--color-combat); font-weight: bold;">[DERROTA!] Seu her√≥i foi derrotado e perdeu ${goldLoss} üí∞.</p>`);
            logToCombat(`Her√≥i se recupera. HP restaurado para ${heroMaxHP}.`);
        }
        
        // Garante que o her√≥i tenha vida m√°xima para a pr√≥xima luta
        heroCurrentHP = heroMaxHP; 

        // Seleciona o pr√≥ximo monstro imediatamente ap√≥s a batalha
        selectMonsterByLevel();
        updateDisplay();
        saveGame();
    }


    // ====================================================================
    // VIII. FUN√á√ïES DE EQUIPAMENTO E INVENT√ÅRIO
    // ====================================================================

    // 1. Renderiza os slots de equipamento
    function renderEquipment() {
        equipmentPanel.innerHTML = ''; // Limpa o painel
        
        for (const key in EQUIPMENT_SLOTS) {
            const slot = EQUIPMENT_SLOTS[key];
            const item = slot.currentItem;

            const slotDiv = document.createElement('div');
            slotDiv.className = 'slot-container';

            const labelSpan = document.createElement('span');
            labelSpan.className = 'slot-label';
            labelSpan.textContent = slot.name + ':';

            const itemDisplay = document.createElement('div');
            itemDisplay.className = 'equipped-item-display';

            if (item) {
                let statText = '';
                if (item.atk) statText = `+${item.atk} ATK`;
                else if (item.hpBonus) statText = `+${item.hpBonus} HP`;
                else if (item.energyBonus) statText = `+${item.energyBonus} EN`;

                itemDisplay.innerHTML = `<span style="font-weight: bold;">${item.name}</span> <span style="font-size: 0.8em; color: var(--color-hp);">(${statText})</span>`;
                itemDisplay.onclick = () => inspectItem(item);
                itemDisplay.style.cursor = 'pointer';
            } else {
                itemDisplay.innerHTML = `<span class="empty-slot">Nenhum item equipado.</span>`;
            }

            slotDiv.appendChild(labelSpan);
            slotDiv.appendChild(itemDisplay);
            equipmentPanel.appendChild(slotDiv);
        }

        // Garante que o painel de detalhes est√° oculto ao abrir a aba
        if (itemDetailsPanel) itemDetailsPanel.style.display = 'none';

        // Atualiza as estat√≠sticas globais ap√≥s a renderiza√ß√£o
        updateEquipmentStats();
    }


    // 2. Calcula e atualiza as estat√≠sticas do Her√≥i (Base + Equipamento)
    function updateEquipmentStats() {
        let bonusHP = 0;
        let bonusATK = 0;
        let bonusEnergy = 0;

        // Itera sobre o equipamento para calcular os b√¥nus
        for (const slotKey in EQUIPMENT_SLOTS) {
            const item = EQUIPMENT_SLOTS[slotKey].currentItem;
            if (item) {
                bonusHP += item.hpBonus || 0;
                bonusATK += item.atk || 0;
                bonusEnergy += item.energyBonus || 0;
            }
        }
        
        // 1. Calcula os Totais
        let totalMaxHP = heroBaseHP + bonusHP;
        let totalMaxATK = heroBaseATK + bonusATK;
        let totalMaxEnergy = 100 + bonusEnergy; // Base de Energia Fixa (exemplo)

        // 2. Aplica ao estado global (importante para combate)
        heroMaxHP = totalMaxHP; 
        
        // 3. Renderiza o painel de estat√≠sticas totais
        heroStatsEquipment.innerHTML = `
            <p style="color: var(--color-hp);">‚ù§Ô∏è HP M√°ximo: <span id="eq-max-hp">${totalMaxHP}</span> (Base: <span id="eq-base-hp">${heroBaseHP}</span> + B√¥nus: <span id="eq-bonus-hp">${bonusHP}</span>)</p>
            <p style="color: var(--color-combat);">‚öîÔ∏è ATK Total: <span id="eq-total-atk">${totalMaxATK}</span> (Base: <span id="eq-base-atk">${heroBaseATK}</span> + B√¥nus: <span id="eq-bonus-atk">${bonusATK}</span>)</p>
            <p style="color: var(--color-energy);">‚ö° Energia M√°xima: <span id="eq-max-energy">${totalMaxEnergy}</span> (Base: 100 + B√¥nus: <span id="eq-bonus-energy">${bonusEnergy}</span>)</p>
        `;
        
        // Garante que o HP atual n√£o ultrapasse o m√°ximo
        heroCurrentHP = Math.min(heroCurrentHP, heroMaxHP);
        
        // Atualiza o display principal
        heroCurrentHPDisplay.textContent = heroCurrentHP;
        heroMaxHPDisplay.textContent = heroMaxHP;
        heroTotalATKDisplay.textContent = totalMaxATK;
        
        // Multiplicador de Dano (Exemplo: +20% por n√≠vel)
        const levelMultiplier = powerLevel > 0 ? (1 + (powerLevel - 1) * 0.2) : 1;
        heroLevelMultiplierDisplay.textContent = levelMultiplier.toFixed(1);

        saveGame(); // Salva o novo estado ap√≥s o update
    }

    // 3. Renderiza os itens no invent√°rio
    function renderInventory() {
        inventoryPanel.innerHTML = '';
        
        // Marca quais itens est√£o equipados
        const equippedIds = Object.values(EQUIPMENT_SLOTS)
                                .map(slot => slot.currentItem ? slot.currentItem.id : null)
                                .filter(id => id !== null);

        inventory.forEach(item => {
            const card = document.createElement('div');
            card.className = `item-card ${equippedIds.includes(item.id) ? 'equipped' : ''}`;
            
            let statText = '';
            if (item.atk) statText = `+${item.atk} ATK`;
            else if (item.hpBonus) statText = `+${item.hpBonus} HP`;
            else if (item.energyBonus) statText = `+${item.energyBonus} EN`;
            
            card.innerHTML = `
                <img src="assets/item-icon.png" alt="${item.name} Icon" style="width: 40px; height: 40px;">
                <p style="font-weight: bold;">${item.name}</p>
                <p style="color: #ccc;">${item.rarity} - ${item.type}</p>
                <p style="color: var(--color-accent);">${statText}</p>
            `;
            
            card.onclick = () => inspectItem(item);
            
            inventoryPanel.appendChild(card);
        });
        
        // Esconde o painel de detalhes se o item inspecionado n√£o estiver mais no invent√°rio
        if (inspectedItem && !inventory.some(i => i.id === inspectedItem.id)) {
            itemDetailsPanel.style.display = 'none';
            inspectedItem = null;
        }
        
    }


    // 4. Inspeciona um item e mostra detalhes/op√ß√µes
    function inspectItem(item) {
        inspectedItem = item; // Define o item inspecionado
        
        const isEquipped = Object.values(EQUIPMENT_SLOTS).some(slot => slot.currentItem && slot.currentItem.id === item.id);
        const canEquip = item.type === 'weapon' || item.type === 'armor'; // Assume que s√≥ arma e armadura podem ser equipados

        let detailsHTML = `
            <h3>${item.name}</h3>
            <p><strong>Tipo:</strong> ${item.type}</p>
            <p><strong>Raridade:</strong> <span style="color: ${item.rarity === 'Comum' ? '#95a5a6' : 'var(--color-accent)'}">${item.rarity}</span></p>
            <p><strong>Descri√ß√£o:</strong> <em>${item.description}</em></p>
            <hr>
            <p><strong>B√¥nus:</strong></p>
            <ul>
                ${item.atk ? `<li>‚öîÔ∏è +${item.atk} ATK</li>` : ''}
                ${item.hpBonus ? `<li>‚ù§Ô∏è +${item.hpBonus} HP</li>` : ''}
                ${item.energyBonus ? `<li>‚ö° +${item.energyBonus} Energia</li>` : ''}
            </ul>
        `;
        
        let actionButton = '';
        if (isEquipped) {
            actionButton = `<button onclick="unequipItem(inspectedItem)" style="background-color: var(--color-combat);">DESEQUIPAR</button>`;
        } else if (canEquip) {
            actionButton = `<button onclick="equipItem(inspectedItem, true)" style="background-color: var(--color-hp);">EQUIPAR</button>`;
        }
        
        let sellButton = `<button onclick="sellItem(inspectedItem)" style="background-color: var(--color-accent); margin-left: 10px;">VENDER (1 üí∞)</button>`;

        // Renderiza o painel de detalhes no invent√°rio
        if (itemDetailsPanel) {
            itemDetailsPanel.innerHTML = detailsHTML + `<div style="margin-top: 15px;">${actionButton} ${sellButton}</div>`;
            itemDetailsPanel.style.display = 'block';
        }
    }


    // 5. Equipa o item (Chamada em finalizeCreation e em inspectItem)
    function equipItem(item, showAlert = true) {
        const slotKey = item.type; 

        if (!EQUIPMENT_SLOTS[slotKey]) {
            if (showAlert) alert(`N√£o √© poss√≠vel equipar este item: Slot de ${slotKey} desconhecido.`);
            return;
        }
        
        // O item est√° sendo equipado, ent√£o ele substitui o item atual no slot
        EQUIPMENT_SLOTS[slotKey].currentItem = item;
        
        // Atualiza todos os pain√©is
        renderEquipment();
        renderInventory();
        if (showAlert) inspectItem(item); // Reinspeciona para mostrar "DESEQUIPAR"
        saveGame();
        if (showAlert) alert(`${item.name} equipado no slot de ${EQUIPMENT_SLOTS[slotKey].name}.`);
    }
    
    // 6. Desequipa o item
    function unequipItem(item) {
        const slotKey = item.type;
        
        if (EQUIPMENT_SLOTS[slotKey].currentItem && EQUIPMENT_SLOTS[slotKey].currentItem.id === item.id) {
             EQUIPMENT_SLOTS[slotKey].currentItem = null;
             alert(`${item.name} desequipado.`);
        }
        
        // Atualiza todos os pain√©is
        renderEquipment();
        renderInventory();
        // Reinspeciona para atualizar o bot√£o para "EQUIPAR"
        if (inspectedItem) {
            inspectItem(inspectedItem); 
        }
        saveGame();
    }
    
    // 7. Vender Item
    function sellItem(item) {
        // Encontra o item no invent√°rio
        const itemIndex = inventory.findIndex(i => i.id === item.id);
        
        if (itemIndex > -1) {
            // Se estiver equipado, desequipa primeiro
            const isEquipped = Object.values(EQUIPMENT_SLOTS).some(slot => slot.currentItem && slot.currentItem.id === item.id);
            if (isEquipped) {
                unequipItem(item); // Desequipa
            }

            // Remove do invent√°rio
            inventory.splice(itemIndex, 1);
            gold += 1; // Recompensa de venda fixa (exemplo)
            
            // Oculta o painel de detalhes
            if (itemDetailsPanel) {
                itemDetailsPanel.style.display = 'none';
                inspectedItem = null;
            }

            alert(`Voc√™ vendeu ${item.name} por 1 üí∞.`);
            
            renderInventory(); // Re-renderiza o invent√°rio
            updateDisplay();
            saveGame();
        } else {
            alert("Erro: Item n√£o encontrado no invent√°rio.");
        }
    }


    // ====================================================================
    // IX. INICIALIZA√á√ÉO
    // ====================================================================

    // Tenta carregar o jogo salvo ao iniciar a p√°gina. 
    loadGame();
    
</script>
